- name: Create OTEManager LXC
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../group_vars/proxmox.yml

  vars:
    vmid: 202
    hostname: otemanager
    storage: local-lvm
    ostemplate: "local:vztmpl/debian-13-standard_13.1-1_amd64.tar.zst"
    cores: 2
    memory: 2048
    rootfs_size: 16
    bridge: vmbr0

  tasks:
    - name: Create container
      community.proxmox.proxmox:
        api_host: "{{ proxmox_api_host }}"
        api_user: "{{ proxmox_api_user }}"
        api_token_id: "{{ proxmox_api_token_id }}"
        api_token_secret: "{{ proxmox_api_token_secret }}"
        validate_certs: "{{ proxmox_validate_certs }}"
        node: "{{ proxmox_node }}"
        vmid: "{{ vmid }}"
        hostname: "{{ hostname }}"
        ostemplate: "{{ ostemplate }}"
        unprivileged: true
        cores: "{{ cores }}"
        memory: "{{ memory }}"
        disk: "{{ storage }}:{{ rootfs_size }}"
        netif:
          net0: "name=eth0,bridge={{ bridge }},ip=dhcp"
        state: present

    - name: Start container
      community.proxmox.proxmox:
        api_host: "{{ proxmox_api_host }}"
        api_user: "{{ proxmox_api_user }}"
        api_token_id: "{{ proxmox_api_token_id }}"
        api_token_secret: "{{ proxmox_api_token_secret }}"
        validate_certs: "{{ proxmox_validate_certs }}"
        node: "{{ proxmox_node }}"
        vmid: "{{ vmid }}"
        hostname: "{{ hostname }}"
        state: started

- name: Install OTEManager application
  hosts: proxmox
  gather_facts: false
  vars_files:
    - ../group_vars/proxmox.yml
  vars:
    vmid: 202
    repo_url: "https://github.com/ahzs645/OTEManager.git"
    db_user: otemanager
    db_password: "{{ otemanager_db_password }}"
    db_host: "{{ otemanager_postgres_ip }}"
    minio_host: "{{ otemanager_minio_ip }}"
    minio_user: "admin"
    minio_password: "{{ minio_admin_password }}"

  tasks:
    - name: Wait for container to be ready
      ansible.builtin.shell: |
        sleep 5
      args:
        executable: /bin/bash

    - name: Install Node.js 22 and build tools
      ansible.builtin.shell: |
        sudo pct exec {{ vmid }} -- bash -lc "
          apt-get update -y
          apt-get install -y curl ca-certificates git build-essential
          curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
          apt-get install -y nodejs
        "
      args:
        executable: /bin/bash

    - name: Clone OTEManager repo
      ansible.builtin.shell: |
        sudo pct exec {{ vmid }} -- bash -lc "
          git clone {{ repo_url }} /opt/otemanager || (cd /opt/otemanager && git pull)
        "
      args:
        executable: /bin/bash

    - name: Install npm dependencies
      ansible.builtin.shell: |
        sudo pct exec {{ vmid }} -- bash -lc "
          cd /opt/otemanager && npm install
        "
      args:
        executable: /bin/bash

    - name: Create .env file
      ansible.builtin.shell: |
        ENCODED_PW=$(python3 -c "import urllib.parse; print(urllib.parse.quote('{{ db_password }}', safe=''))")
        sudo pct exec {{ vmid }} -- bash -c "cat > /opt/otemanager/.env <<ENVEOF
        DATABASE_URL=postgresql://{{ db_user }}:${ENCODED_PW}@{{ db_host }}:5432/otemanager
        UPLOAD_DIR=./uploads
        MAX_FILE_SIZE=52428800
        S3_BUCKET=ote-articles
        S3_REGION=us-east-1
        S3_ENDPOINT=http://{{ minio_host }}:9000
        AWS_ACCESS_KEY_ID={{ minio_user }}
        AWS_SECRET_ACCESS_KEY={{ minio_password }}
        ENVEOF
        "
      args:
        executable: /bin/bash

    - name: Run database migrations
      ansible.builtin.shell: |
        sudo pct exec {{ vmid }} -- bash -lc "
          cd /opt/otemanager && npm run db:push
        "
      args:
        executable: /bin/bash

    - name: Build the application
      ansible.builtin.shell: |
        sudo pct exec {{ vmid }} -- bash -lc "
          cd /opt/otemanager && npm run build
        "
      args:
        executable: /bin/bash

    - name: Create systemd service
      ansible.builtin.shell: |
        sudo pct exec {{ vmid }} -- bash -lc "cat > /etc/systemd/system/otemanager.service <<'EOF'
        [Unit]
        Description=OTEManager
        After=network-online.target
        Wants=network-online.target

        [Service]
        WorkingDirectory=/opt/otemanager
        ExecStart=/usr/bin/node .output/server/index.mjs
        Restart=always
        EnvironmentFile=/opt/otemanager/.env

        [Install]
        WantedBy=multi-user.target
        EOF
        systemctl daemon-reload
        systemctl enable --now otemanager
        "
      args:
        executable: /bin/bash
